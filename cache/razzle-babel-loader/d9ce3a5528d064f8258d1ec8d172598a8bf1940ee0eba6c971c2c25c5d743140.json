{"ast":null,"code":"import _extends from \"/home/tooler/code/work/forests-frontend/node_modules/@babel/runtime/helpers/esm/extends.js\";\nimport _slicedToArray from \"/home/tooler/code/work/forests-frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nvar _jsxFileName = \"/home/tooler/code/work/forests-frontend/node_modules/volto-slate/src/widgets/HtmlSlateWidget.jsx\",\n  _this = this,\n  _s = $RefreshSig$();\nvar __jsx = React.createElement;\n/**\n * HtmlSlateWidget, a slate widget variant that saves its data as HTML\n */\n\nimport React from 'react';\nimport ReactDOMServer from 'react-dom/server';\nimport configureStore from 'redux-mock-store';\nimport { MemoryRouter } from 'react-router-dom';\nimport { Provider, useSelector } from 'react-redux';\nimport { defineMessages, injectIntl } from 'react-intl';\nimport { FormFieldWrapper } from '@plone/volto/components';\nimport SlateEditor from 'volto-slate/editor/SlateEditor';\nimport { serializeNodes } from 'volto-slate/editor/render';\nimport { makeEditor } from 'volto-slate/utils';\nimport deserialize from 'volto-slate/editor/deserialize';\nimport { createEmptyParagraph, normalizeExternalData } from 'volto-slate/utils';\nimport { ErrorBoundary } from './ErrorBoundary';\nimport './style.css';\nvar messages = defineMessages({\n  error: {\n    \"id\": \"An error has occurred while editing \\\"{name}\\\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.\",\n    \"defaultMessage\": \"An error has occurred while editing \\\"{name}\\\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.\"\n  }\n});\nvar HtmlSlateWidget = function HtmlSlateWidget(props) {\n  _s();\n  var id = props.id,\n    onChange = props.onChange,\n    value = props.value,\n    focus = props.focus,\n    className = props.className,\n    block = props.block,\n    placeholder = props.placeholder,\n    properties = props.properties,\n    intl = props.intl;\n  var _React$useState = React.useState(focus),\n    _React$useState2 = _slicedToArray(_React$useState, 2),\n    selected = _React$useState2[0],\n    setSelected = _React$useState2[1];\n  var editor = React.useMemo(function () {\n    return makeEditor();\n  }, []);\n  var token = useSelector(function (state) {\n    return state.userSession.token;\n  });\n  var toHtml = React.useCallback(function (value) {\n    var mockStore = configureStore();\n    var html = ReactDOMServer.renderToStaticMarkup(__jsx(Provider, {\n      store: mockStore({\n        userSession: {\n          token: token\n        }\n      }),\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 55,\n        columnNumber: 9\n      }\n    }, __jsx(MemoryRouter, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 56,\n        columnNumber: 11\n      }\n    }, serializeNodes(value || []))));\n    // console.log('toHtml value', JSON.stringify(value));\n    // console.log('toHtml html', html);\n\n    return {\n      'content-type': value ? value['content-type'] : 'text/html',\n      encoding: value ? value.encoding : 'utf8',\n      data: html\n    };\n  }, [token]);\n  var fromHtml = React.useCallback(function (value) {\n    var html = (value === null || value === void 0 ? void 0 : value.data) || '';\n    var parsed = new DOMParser().parseFromString(html, 'text/html');\n    var body = parsed.getElementsByTagName('google-sheets-html-origin').length > 0 ? parsed.querySelector('google-sheets-html-origin > table') : parsed.body;\n    var data = deserialize(editor, body);\n    data = normalizeExternalData(editor, data);\n\n    // editor.children = data;\n    // Editor.normalize(editor);\n    // TODO: need to add {text: \"\"} placeholders between elements\n    var res = data.length ? data : [createEmptyParagraph()];\n    // console.log('from html', { html: value?.data, res });\n    return res;\n  }, [editor]);\n  var valueFromHtml = React.useMemo(function () {\n    return fromHtml(value);\n  }, [value, fromHtml]);\n  var handleChange = React.useCallback(function (newValue) {\n    onChange(id, toHtml(newValue));\n  }, [onChange, toHtml, id]);\n  var handleClick = React.useCallback(function () {\n    setSelected(true);\n  }, []);\n  return __jsx(FormFieldWrapper, _extends({}, props, {\n    draggable: false,\n    className: \"slate_wysiwyg\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 109,\n      columnNumber: 5\n    }\n  }), __jsx(\"div\", {\n    className: \"slate_wysiwyg_box\",\n    role: \"textbox\",\n    tabIndex: \"-1\",\n    style: {\n      boxSizing: 'initial'\n    },\n    onClick: handleClick,\n    onKeyDown: function onKeyDown() {},\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 110,\n      columnNumber: 7\n    }\n  }, __jsx(ErrorBoundary, {\n    name: intl.formatMessage(messages.error, {\n      name: id\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 118,\n      columnNumber: 9\n    }\n  }, __jsx(SlateEditor, {\n    className: className,\n    id: id,\n    name: id,\n    value: valueFromHtml,\n    onChange: handleChange,\n    block: block,\n    selected: selected,\n    properties: properties,\n    placeholder: placeholder,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 119,\n      columnNumber: 11\n    }\n  }))));\n};\n_s(HtmlSlateWidget, \"5QVgoyGmX8qPxdfyLQhITSgJC04=\", false, function () {\n  return [useSelector];\n});\n_c = HtmlSlateWidget;\nexport default _c2 = injectIntl(HtmlSlateWidget);\nvar _c, _c2;\n$RefreshReg$(_c, \"HtmlSlateWidget\");\n$RefreshReg$(_c2, \"%default%\");","map":{"version":3,"names":["React","ReactDOMServer","configureStore","MemoryRouter","Provider","useSelector","defineMessages","injectIntl","FormFieldWrapper","SlateEditor","serializeNodes","makeEditor","deserialize","createEmptyParagraph","normalizeExternalData","ErrorBoundary","messages","error","HtmlSlateWidget","props","id","onChange","value","focus","className","block","placeholder","properties","intl","useState","selected","setSelected","editor","useMemo","token","state","userSession","toHtml","useCallback","mockStore","html","renderToStaticMarkup","encoding","data","fromHtml","parsed","DOMParser","parseFromString","body","getElementsByTagName","length","querySelector","res","valueFromHtml","handleChange","newValue","handleClick","boxSizing","formatMessage","name"],"sources":["/home/tooler/code/work/forests-frontend/node_modules/volto-slate/src/widgets/HtmlSlateWidget.jsx"],"sourcesContent":["/**\n * HtmlSlateWidget, a slate widget variant that saves its data as HTML\n */\n\nimport React from 'react';\nimport ReactDOMServer from 'react-dom/server';\nimport configureStore from 'redux-mock-store';\nimport { MemoryRouter } from 'react-router-dom';\nimport { Provider, useSelector } from 'react-redux';\nimport { defineMessages, injectIntl } from 'react-intl';\n\nimport { FormFieldWrapper } from '@plone/volto/components';\nimport SlateEditor from 'volto-slate/editor/SlateEditor';\nimport { serializeNodes } from 'volto-slate/editor/render';\nimport { makeEditor } from 'volto-slate/utils';\nimport deserialize from 'volto-slate/editor/deserialize';\n\nimport { createEmptyParagraph, normalizeExternalData } from 'volto-slate/utils';\nimport { ErrorBoundary } from './ErrorBoundary';\n\nimport './style.css';\n\nconst messages = defineMessages({\n  error: {\n    id:\n      'An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.',\n    defaultMessage:\n      'An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.',\n  },\n});\n\nconst HtmlSlateWidget = (props) => {\n  const {\n    id,\n    onChange,\n    value,\n    focus,\n    className,\n    block,\n    placeholder,\n    properties,\n    intl,\n  } = props;\n\n  const [selected, setSelected] = React.useState(focus);\n\n  const editor = React.useMemo(() => makeEditor(), []);\n\n  const token = useSelector((state) => state.userSession.token);\n\n  const toHtml = React.useCallback(\n    (value) => {\n      const mockStore = configureStore();\n      const html = ReactDOMServer.renderToStaticMarkup(\n        <Provider store={mockStore({ userSession: { token } })}>\n          <MemoryRouter>{serializeNodes(value || [])}</MemoryRouter>\n        </Provider>,\n      );\n      // console.log('toHtml value', JSON.stringify(value));\n      // console.log('toHtml html', html);\n\n      return {\n        'content-type': value ? value['content-type'] : 'text/html',\n        encoding: value ? value.encoding : 'utf8',\n        data: html,\n      };\n    },\n    [token],\n  );\n\n  const fromHtml = React.useCallback(\n    (value) => {\n      const html = value?.data || '';\n\n      const parsed = new DOMParser().parseFromString(html, 'text/html');\n      const body =\n        parsed.getElementsByTagName('google-sheets-html-origin').length > 0\n          ? parsed.querySelector('google-sheets-html-origin > table')\n          : parsed.body;\n      let data = deserialize(editor, body);\n      data = normalizeExternalData(editor, data);\n\n      // editor.children = data;\n      // Editor.normalize(editor);\n      // TODO: need to add {text: \"\"} placeholders between elements\n      const res = data.length ? data : [createEmptyParagraph()];\n      // console.log('from html', { html: value?.data, res });\n      return res;\n    },\n    [editor],\n  );\n\n  const valueFromHtml = React.useMemo(() => {\n    return fromHtml(value);\n  }, [value, fromHtml]);\n\n  const handleChange = React.useCallback(\n    (newValue) => {\n      onChange(id, toHtml(newValue));\n    },\n    [onChange, toHtml, id],\n  );\n\n  const handleClick = React.useCallback(() => {\n    setSelected(true);\n  }, []);\n\n  return (\n    <FormFieldWrapper {...props} draggable={false} className=\"slate_wysiwyg\">\n      <div\n        className=\"slate_wysiwyg_box\"\n        role=\"textbox\"\n        tabIndex=\"-1\"\n        style={{ boxSizing: 'initial' }}\n        onClick={handleClick}\n        onKeyDown={() => {}}\n      >\n        <ErrorBoundary name={intl.formatMessage(messages.error, { name: id })}>\n          <SlateEditor\n            className={className}\n            id={id}\n            name={id}\n            value={valueFromHtml}\n            onChange={handleChange}\n            block={block}\n            selected={selected}\n            properties={properties}\n            placeholder={placeholder}\n          />\n        </ErrorBoundary>\n      </div>\n    </FormFieldWrapper>\n  );\n};\n\nexport default injectIntl(HtmlSlateWidget);\n"],"mappings":"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"},"metadata":{"react-intl":{"messages":[{"id":"An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator.","defaultMessage":"An error has occurred while editing \"{name}\" field. We have been notified and we are looking into it. Please save your work and retry. If the issue persists please contact the site administrator."}]}},"sourceType":"module","externalDependencies":[]}