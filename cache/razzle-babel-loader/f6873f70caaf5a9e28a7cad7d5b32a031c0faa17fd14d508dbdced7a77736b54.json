{"ast":null,"code":"import _map from \"lodash/map\";\n/**\n * Sitemap helper.\n * @module helpers/Sitemap\n */\n\nimport superagent from 'superagent';\nimport zlib from 'zlib';\nimport { toPublicURL } from '@plone/volto/helpers';\nimport { addHeadersFactory } from '@plone/volto/helpers/Proxy/Proxy';\nimport config from '@plone/volto/registry';\n\n/**\n * Generate sitemap\n * @function generateSitemap\n * @param {Object} _req Request object\n * @return {string} Generated sitemap\n */\nexport const generateSitemap = _req => new Promise(resolve => {\n  var _settings$internalApi;\n  const {\n    settings\n  } = config;\n  const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n  const apiPath = (_settings$internalApi = settings.internalApiPath) !== null && _settings$internalApi !== void 0 ? _settings$internalApi : settings.apiPath;\n  const request = superagent.get(`${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_size=100000000&use_site_search_settings=1`);\n  request.set('Accept', 'application/json');\n  request.use(addHeadersFactory(_req));\n  const authToken = _req.universalCookies.get('auth_token');\n  if (authToken) {\n    request.set('Authorization', `Bearer ${authToken}`);\n  }\n  request.end((error, {\n    body\n  } = {}) => {\n    if (error) {\n      resolve(body || error);\n    } else {\n      const items = _map(body.items, item => `  <url>\\n    <loc>${toPublicURL(item['@id'])}</loc>\\n\n            <lastmod>${item.modified}</lastmod>\\n  </url>`);\n      const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">\\n${items.join('\\n')}\\n</urlset>`;\n      zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n        resolve(buffer);\n      });\n    }\n  });\n});","map":{"version":3,"names":["superagent","zlib","toPublicURL","addHeadersFactory","config","generateSitemap","_req","Promise","resolve","settings","APISUFIX","legacyTraverse","apiPath","internalApiPath","request","get","set","use","authToken","universalCookies","end","error","body","items","item","modified","result","join","gzip","Buffer","from","_err","buffer"],"sources":["/home/tooler/code/work/forests-frontend/node_modules/@plone/volto/src/helpers/Sitemap/Sitemap.js"],"sourcesContent":["/**\n * Sitemap helper.\n * @module helpers/Sitemap\n */\n\nimport superagent from 'superagent';\nimport { map } from 'lodash';\nimport zlib from 'zlib';\nimport { toPublicURL } from '@plone/volto/helpers';\nimport { addHeadersFactory } from '@plone/volto/helpers/Proxy/Proxy';\n\nimport config from '@plone/volto/registry';\n\n/**\n * Generate sitemap\n * @function generateSitemap\n * @param {Object} _req Request object\n * @return {string} Generated sitemap\n */\nexport const generateSitemap = (_req) =>\n  new Promise((resolve) => {\n    const { settings } = config;\n    const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n    const apiPath = settings.internalApiPath ?? settings.apiPath;\n    const request = superagent.get(\n      `${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_size=100000000&use_site_search_settings=1`,\n    );\n    request.set('Accept', 'application/json');\n    request.use(addHeadersFactory(_req));\n    const authToken = _req.universalCookies.get('auth_token');\n    if (authToken) {\n      request.set('Authorization', `Bearer ${authToken}`);\n    }\n    request.end((error, { body } = {}) => {\n      if (error) {\n        resolve(body || error);\n      } else {\n        const items = map(\n          body.items,\n          (item) =>\n            `  <url>\\n    <loc>${toPublicURL(item['@id'])}</loc>\\n\n            <lastmod>${item.modified}</lastmod>\\n  </url>`,\n        );\n        const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">\\n${items.join(\n          '\\n',\n        )}\\n</urlset>`;\n        zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n          resolve(buffer);\n        });\n      }\n    });\n  });\n"],"mappings":";AAAA;AACA;AACA;AACA;;AAEA,OAAOA,UAAU,MAAM,YAAY;AAEnC,OAAOC,IAAI,MAAM,MAAM;AACvB,SAASC,WAAW,QAAQ,sBAAsB;AAClD,SAASC,iBAAiB,QAAQ,kCAAkC;AAEpE,OAAOC,MAAM,MAAM,uBAAuB;;AAE1C;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,eAAe,GAAIC,IAAI,IAClC,IAAIC,OAAO,CAAEC,OAAO,IAAK;EAAA;EACvB,MAAM;IAAEC;EAAS,CAAC,GAAGL,MAAM;EAC3B,MAAMM,QAAQ,GAAGD,QAAQ,CAACE,cAAc,GAAG,EAAE,GAAG,UAAU;EAC1D,MAAMC,OAAO,4BAAGH,QAAQ,CAACI,eAAe,yEAAIJ,QAAQ,CAACG,OAAO;EAC5D,MAAME,OAAO,GAAGd,UAAU,CAACe,GAAG,CAC3B,GAAEH,OAAQ,GAAEF,QAAS,+EAA8E,CACrG;EACDI,OAAO,CAACE,GAAG,CAAC,QAAQ,EAAE,kBAAkB,CAAC;EACzCF,OAAO,CAACG,GAAG,CAACd,iBAAiB,CAACG,IAAI,CAAC,CAAC;EACpC,MAAMY,SAAS,GAAGZ,IAAI,CAACa,gBAAgB,CAACJ,GAAG,CAAC,YAAY,CAAC;EACzD,IAAIG,SAAS,EAAE;IACbJ,OAAO,CAACE,GAAG,CAAC,eAAe,EAAG,UAASE,SAAU,EAAC,CAAC;EACrD;EACAJ,OAAO,CAACM,GAAG,CAAC,CAACC,KAAK,EAAE;IAAEC;EAAK,CAAC,GAAG,CAAC,CAAC,KAAK;IACpC,IAAID,KAAK,EAAE;MACTb,OAAO,CAACc,IAAI,IAAID,KAAK,CAAC;IACxB,CAAC,MAAM;MACL,MAAME,KAAK,GAAG,KACZD,IAAI,CAACC,KAAK,EACTC,IAAI,IACF,qBAAoBtB,WAAW,CAACsB,IAAI,CAAC,KAAK,CAAC,CAAE;AAC1D,uBAAuBA,IAAI,CAACC,QAAS,sBAAqB,CACjD;MACD,MAAMC,MAAM,GAAI,wRAAuRH,KAAK,CAACI,IAAI,CAC/S,IAAI,CACJ,aAAY;MACd1B,IAAI,CAAC2B,IAAI,CAACC,MAAM,CAACC,IAAI,CAACJ,MAAM,EAAE,MAAM,CAAC,EAAE,CAACK,IAAI,EAAEC,MAAM,KAAK;QACvDxB,OAAO,CAACwB,MAAM,CAAC;MACjB,CAAC,CAAC;IACJ;EACF,CAAC,CAAC;AACJ,CAAC,CAAC"},"metadata":{"react-intl":{"messages":[]}},"sourceType":"module","externalDependencies":[]}